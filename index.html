<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Performance Based CBT</title>

  <style>
    :root{
  --bg1:#eef2ff; --bg2:#f3e8ff; --card:#fff;
  --accent1:#6a11cb; --accent2:#2575fc;
  --ink:#0f172a; --muted:#6b7280;
  --danger:#d32f2f; --success:#10b981;
  --radius:14px;
  --container: min(1200px, 96vw);
  --headH: 72px; /* set from JS for exact lock */
}
*{box-sizing:border-box}
html,body{
  margin:0; padding:0; min-height:100%;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  font-family:Inter,system-ui,"Segoe UI",Roboto,Arial,sans-serif;
  color:var(--ink); overflow-x:hidden; text-align:center;
}
body{padding:clamp(8px,1.6vw,18px)}

.app{
  width:var(--container); max-width:100%;
  margin:0 auto; text-align:left;
  background:linear-gradient(180deg,rgba(255,255,255,0.98),#fbfbff);
  border:1px solid rgba(124,77,255,0.06);
  border-radius:18px; box-shadow:0 20px 40px rgba(15,23,42,0.08);
}
header{padding:16px; text-align:center; background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:#fff}
header h1{margin:0; font-size:18px}
header p{margin:6px 0 0; font-size:12px; opacity:.95}

/* --- Layout --- */
.layout{ display:grid; grid-template-columns:1fr; gap:12px; padding:12px; }
@media (min-width:900px){
  .layout{
    grid-template-columns:clamp(300px,28vw,380px) 1fr;
    align-items:start; gap:clamp(12px,2vw,18px);
  }
}

.panel{ background:var(--card); border:1px solid #e9ecff; border-radius:12px; padding:12px; }
.row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
label{display:block; font-weight:700; color:#334155; font-size:13px; margin-bottom:6px}
input[type="text"]{
  flex:1; min-width:200px; padding:12px;
  border:1px solid #eef3ff; border-radius:10px; font-size:14px
}
.btn{
  padding:10px 14px; border-radius:10px; border:none; cursor:pointer;
  background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:#fff;
  font-weight:700; box-shadow:0 6px 18px rgba(92,109,255,0.08)
}
.btn.ghost{background:#fff; color:var(--accent1); border:1px solid #cfd7ff; box-shadow:none}
.btn.warn{background:linear-gradient(90deg,#ff6b6b,#d32f2f)}
.btn:disabled{opacity:.6; cursor:not-allowed}
.btn.warn {
  color: #ffffff; /* default white — change this */
}
.small{font-size:12px; color:#6b7280}
.tag{font-size:11px; padding:4px 8px; border-radius:999px; background:#eef2ff; color:#334155}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

/* === TIMER PANEL === */
.panelTimer{
  position:sticky; top:0; z-index:10;
  display:flex; justify-content:center; align-items:center;
  gap:12px; padding:12px; margin-bottom:12px;
  background:#ffffffee; border-radius:14px; border:1px solid #e5e7ff;
  backdrop-filter:saturate(1.05) blur(2px);
}
.timerBox{display:flex; align-items:center; gap:10px; font-weight:700}
#timer{
  color:var(--danger); padding:6px 14px; background:#fff;
  border-radius:10px; border:1px solid #f3dada; font-size:20px; font-weight:800
}
.qMeta{font-size:18px; font-weight:800; color:#0f172a}

.qNavRow{
  width:100%; display:flex; justify-content:center; align-items:center;
  gap:12px; margin: 12px 0;
}
.qNavRow button{
  flex:1; max-width:140px; padding:10px 0; border-radius:10px; font-weight:700;
  background:#fff; border:1px solid #cfd7ff; color:#6a11cb; cursor:pointer;
}

/* Progress */
.progressBar{height:8px; background:#f6f8ff; border-radius:999px; overflow:hidden; border:1px solid #e6eaff}
.progressFill{height:100%; background:linear-gradient(90deg,var(--accent1),var(--accent2)); width:0%}

/* Navigation Grid */
.navWrap{max-height:160px; overflow:auto; border:1px solid #eef1ff; border-radius:10px; padding:8px; background:#fff}
.jumpGrid{display:flex; flex-wrap:wrap; gap:6px}
.jumpBtn{width:34px; height:34px; border:1px solid #e3e8ff; border-radius:8px; background:#f0f5ff; cursor:pointer; font-weight:700; line-height:1}
.jumpBtn.answered{background:#cfe4ff}
.jumpBtn.marked{background:#fff7e6}
.jumpBtn.current{
  background:#fff; border-color:#6a11cb; color:#6a11cb;
  box-shadow:0 0 0 2px #e9ddff inset, 0 2px 6px rgba(106,17,203,.18);
  animation:pulse 1.2s ease-out infinite;
}
@keyframes pulse{
  0%{box-shadow:0 0 0 2px #e9ddff inset, 0 0 0 0 rgba(106,17,203,.35)}
  70%{box-shadow:0 0 0 2px #e9ddff inset, 0 0 0 8px rgba(106,17,203,0)}
  100%{box-shadow:0 0 0 2px #e9ddff inset, 0 0 0 0 rgba(106,17,203,0)}
}

/* Question Card */
.questionCard{background:#fff; border:1px solid #eee; border-radius:12px; padding:12px}
.qhead{display:flex; justify-content:space-between; gap:8px; align-items:center; margin-bottom:8px}
.qtext{font-size:17px; font-weight:700; margin:6px 0 10px}
.options label{display:block; padding:10px; margin-bottom:8px; border-radius:10px; border:1px solid #e9efff; background:#f8fbff; cursor:pointer}

/* Tables */
.tableWrap{width:100%;overflow:auto;border:1px solid #eef1ff;border-radius:10px;background:#fff}
table{width:100%;border-collapse:collapse;min-width:720px}
th,td{padding:8px;border-bottom:1px solid #f0f2ff;text-align:left;vertical-align:top}
th{font-size:12px;color:#475569;background:#fafbff;position:sticky;top:0}
td{font-size:13px;line-height:1.3}

/* Metrics */
.metricGrid{display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px}
.metric{border:1px solid #eef1ff; background:#fff; border-radius:12px; padding:12px; text-align:center}
.metricLabel{font-size:12px; color:#475569}
.metricValue{font-size:20px; font-weight:800; margin-top:4px}

/* Topic cards */
.topicCard{border:1px solid #eef1ff; border-radius:12px; background:#fff; padding:10px}
.topicRow{display:flex; justify-content:space-between; gap:10px}
.topicRow .left{font-weight:700}
.topicRow .right{font-family:ui-monospace,monospace}

/* Review collapsibles (mobile) */
.qcard{border:1px solid #eef1ff; border-radius:12px; background:#fff; overflow:hidden}
.qcard summary{cursor:pointer; list-style:none; padding:10px 12px; font-weight:700; display:flex; justify-content:space-between; gap:8px; align-items:center; background:#fbfcff; border-bottom:1px solid #f0f2ff}
.qcard summary::-webkit-details-marker{display:none}
.qcard .body{padding:10px 12px}
.pill{padding:2px 8px; border-radius:999px; font-size:11px; background:#eef2ff}

/* =======================
   FULL-SCREEN RESULTS MODE
   ======================= */
#resultDesktop{ display:none; }
#resultMobile{ display:none; }

/* DESKTOP/TABLET VIEW */
@media (min-width:900px){

  /* ✅ Remove body padding, hide .app, full-width dashboard */
  body.results-mode{
    overflow:hidden;
    padding:0 !important;
  }

  body.results-mode .app{
    display:none;
  }

  #resultDesktop{
    display:block;
    width:100vw;
    margin:0; /* ✅ remove centering */
    border-radius:0;
    border-left:none; border-right:none;
    background:linear-gradient(180deg,var(--bg1),var(--bg2));
    padding-inline:clamp(12px,3vw,28px);
    padding-bottom:16px;
  }

  .resultsDock{
    display:grid;
    grid-template-columns: 260px 1fr;
    gap:clamp(12px,2vw,18px);
    height: calc(100vh - var(--headH) - 16px);
    align-items:stretch;
  }

  .resultsSidebar{
    background:#fff; border:1px solid #e9ecff; border-radius:12px;
    padding:10px;
    display:flex; flex-direction:column; gap:8px;
    height:100%; overflow:auto;
  }

  .tabBtn{
  text-align:left;
  padding:8px 10px;      /* compact padding */
  font-size:14px;        /* compact font */
  border-radius:10px;
  border:1px solid #e9ecff;
  background:#fff;
  cursor:pointer;
  font-weight:700;
  color:#334155;
}
  .tabBtn[aria-selected="true"]{
    color:#6a11cb; border-color:#cfd7ff;
    box-shadow:0 0 0 2px #e9ddff inset;
    background:linear-gradient(180deg,#ffffff,#fbfbff);
  }

  .resultsMain{
    background:transparent;
    height:100%;
    overflow:auto;
  }

  .resultsCard{
    background:#fff; border:1px solid #e9ecff; border-radius:12px; padding:12px; margin-bottom:12px;
  }

  .tabPanel{ display:none; }
  .tabPanel.active{ display:block; }

  .tabPanel .tableWrap table{
    min-width:1000px;
  }
}

/* MOBILE RESULTS */
@media (max-width:899.98px){
  #resultMobile{ display:block; }
}

@media (max-width:560px){
  .metricGrid{grid-template-columns:repeat(2,minmax(0,1fr))}
}
@media (max-width:400px){
  .metricGrid{grid-template-columns:1fr}
}
/* Floating Back Button */
.backHomeBtn {
  position: fixed;
  bottom: 20px;
  left: 20px;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 10px 14px;
  font-weight: 700;
  cursor: pointer;
  z-index: 9999;
  box-shadow: 0 4px 12px rgba(0,0,0,.12);
}

@media (max-width:899px){
  .backHomeBtn { display:none !important; }
}
/* Animated tab transitions */
.tabPanel {
   opacity: 0;
   transform: translateY(8px);
   transition: opacity .25s ease, transform .25s ease;
}

.tabPanel.active {
   opacity: 1;
   transform: translateY(0);
}
/* Scroll shadows in results panel */
.resultsMain {
  position: relative;
}

.resultsMain::before,
.resultsMain::after {
  content: "";
  position: sticky;
  left: 0;
  right: 0;
  height: 14px;
  pointer-events: none;
  z-index: 20;
}

.resultsMain::before {
  top: 0;
  box-shadow: inset 0 8px 10px -8px rgba(0,0,0,.20);
}

.resultsMain::after {
  bottom: 0;
  box-shadow: inset 0 -8px 10px -8px rgba(0,0,0,.20);
}
/* Compact vertical sidebar */
.resultsSidebar {
  padding: 8px;
}

@media (min-width:900px){
  .resultsDock {
    grid-template-columns: 200px 1fr;
  }
}
  </style>
</head>
<body>
  <div class="app">
    <header id="pageHeader">
      <h1>Learners Achievement Test</h1>
      <p>Binary • Ratios • Ratio Word Problems • Prime Factors • LCM/HCF • Fractions • Factorization • Arithmetic Mean • Square Roots</p>
    </header>

    <div class="layout" id="mainLayout">
      <!-- Controls -->
      <section class="panel" aria-label="Student controls">
        <label for="candidateName">Candidate Full Name (2–3 words)</label>
        <div class="row" style="justify-content:center">
          <input id="candidateName" type="text" placeholder="e.g. Amina Yusuf Ade" autocomplete="off" maxlength="60">
          <button class="btn" id="startBtn" title="Begin your test">Start Test</button>
          <button class="btn ghost" id="checkResultBtn" title="View your submitted result (if any)">Check Result</button>
        </div>
        <p class="small" style="margin-top:6px; text-align:center">
          You can check your result any time after submission. Each student may take the test once unless unlocked by the teacher (Admin page).
        </p>

        <div style="margin-top:10px" class="row" role="status" aria-live="polite">
          <div style="flex:1">
            <div class="row" style="align-items:center; gap:10px; justify-content:center">
              <div class="tag">Progress</div>
              <div class="small" id="progressCount">0 / 50 answered</div>
              <div class="small">•</div>
              <div class="small" id="markedCount">0 marked</div>
            </div>
            <div class="progressBar" style="margin-top:6px"><div id="progressFill" class="progressFill"></div></div>
          </div>
        </div>

        <div style="margin-top:10px">
          <div class="row" style="align-items:center; justify-content:space-between">
            <div class="tag">Navigation</div>
            <div class="small">Tap to jump</div>
          </div>
          <div class="navWrap" id="navWrap">
            <div id="jumpGrid" class="jumpGrid" role="navigation" aria-label="Jump to question"></div>
          </div>
        </div>
      </section>

      <!-- Test Area -->
      <section class="panel" id="testPanel" style="display:none">
        <div class="panelTimer">
          <div class="timerBox">
            ⏳ <span id="timer">02:30:00</span>
            <span class="qMeta">• Q <span id="qIndexTop">1</span> / <span id="qTotalTop">50</span></span>
          </div>
        </div>

        <div class="qNavRow" role="group" aria-label="Question navigation">
          <button class="navBtn" id="prevBtn" disabled>Previous</button>
          <button class="navBtn" id="nextBtn">Next</button>
          <button class="navBtn" id="markBtn">Mark</button>
        </div>

        <div id="submitContainer" class="qNavRow"></div>

        <div class="qhead">
          <div class="row small">
            <span id="qIndex" style="visibility:hidden;position:absolute">1</span>
            <span class="tag" id="topicTag">Binary</span>
            <span class="tag" id="difficultyTag">easy</span>
          </div>
        </div>

        <div class="questionCard" aria-live="polite">
          <div class="qtext" id="qText">Loading...</div>
          <div class="options" id="options"></div>
          <div class="small mono" id="timeOnQ">Time on question: 0s</div>
        </div>

        <div class="small" id="statusMsg" aria-live="polite"></div>
      </section>
    </div>
  </div>

  <!-- ===== RESULTS — Desktop: Full-screen dashboard ===== -->
  <section id="resultDesktop" aria-label="Results (desktop/tablet)">
    <div class="resultsDock" id="resultsDock" aria-live="polite" style="display:none">
      <aside class="resultsSidebar" aria-label="Results sections" role="tablist" aria-orientation="vertical">
        <button class="tabBtn" role="tab" aria-selected="true"  data-tab="overview">Overview</button>
        <button class="tabBtn" role="tab" aria-selected="false" data-tab="topics">Topic Analytics</button>
        <button class="tabBtn" role="tab" aria-selected="false" data-tab="review">Per-question Review</button>
      </aside>

      <main class="resultsMain" id="resultsMain">
        <section class="tabPanel active" id="tab-overview" role="tabpanel" aria-labelledby="tab-overview-btn">
          <div class="resultsCard">
            <h2 style="margin:4px 0 8px">Score Overview</h2>
            <p class="small mono" id="resMeta"></p>
            <div class="row" style="justify-content:space-evenly; gap:10px; flex-wrap:wrap">
              <div class="metric"><div class="metricLabel">Score</div><div class="metricValue" id="resScore">—</div></div>
              <div class="metric"><div class="metricLabel">Percent</div><div class="metricValue" id="resPercent">—%</div></div>
              <div class="metric"><div class="metricLabel">Time Used</div><div class="metricValue" id="resTime">—</div></div>
            </div>
          </div>
        </section>

        <section class="tabPanel" id="tab-topics" role="tabpanel">
          <div class="resultsCard">
            <h2 style="margin:0 0 8px">Topic Analytics</h2>
            <div class="tableWrap">
              <table>
                <thead><tr><th>Topic</th><th>Correct</th><th>Total</th><th>Accuracy</th><th>Time</th></tr></thead>
                <tbody id="topicTbody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section class="tabPanel" id="tab-review" role="tabpanel">
          <div class="resultsCard">
            <h2 style="margin:0 0 8px">Per-question Review</h2>
            <div class="tableWrap">
              <table>
                <thead><tr><th>#</th><th>Topic</th><th>Question</th><th>Your Ans</th><th>Correct</th><th>✓/✗</th><th>Time</th></tr></thead>
                <tbody id="detailTbody"></tbody>
              </table>
            </div>
            <p class="small" style="margin-top:10px">Need a PDF? Ask your teacher to download it from the Admin page.</p>
          </div>
        </section>
      </main>
    </div>
  </section>
  <button id="backHomeBtn" class="backHomeBtn" style="display:none">← Back to Home</button>

  <!-- ===== RESULTS — Mobile (stacked cards) ===== -->
  <section class="panel" id="resultMobile" style="display:none">
    <div class="questionCard" style="background:linear-gradient(180deg,#f7fffb,#ffffff)">
      <h2 style="margin:6px 0 10px">Score Overview</h2>
      <p class="small mono" id="m_resMeta"></p>
      <div class="metricGrid" style="margin-top:8px">
        <div class="metric"><div class="metricLabel">Score</div><div class="metricValue" id="m_resScore">—</div></div>
        <div class="metric"><div class="metricLabel">Percent</div><div class="metricValue" id="m_resPercent">—%</div></div>
        <div class="metric"><div class="metricLabel">Time Used</div><div class="metricValue" id="m_resTime">—</div></div>
      </div>
    </div>

    <div class="questionCard">
      <h2 style="margin:0 0 8px">Topic Analytics</h2>
      <div id="topicCards" class="stack" style="display:grid; gap:8px"></div>
    </div>

    <div class="questionCard">
      <h2 style="margin:0 0 8px">Per-question Review</h2>
      <div id="reviewStack" class="stack" style="display:grid; gap:8px"></div>
      <p class="small" style="margin-top:8px">Need a PDF? Ask your teacher to download it from the Admin page.</p>
    </div>
  </section>

  <!-- ===== Embedded question bank ===== -->
  <script type="application/json" id="questionBank">
  [
    { "id":1,"topic":"Binary","difficulty":"easy","q":"Convert decimal 5 to binary.","options":["101","111","110","100"],"answer":"101","explanation":"5 in binary is 101." },
    { "id":2,"topic":"Binary","difficulty":"easy","q":"Convert decimal 9 to binary.","options":["1001","1010","1111","1100"],"answer":"1001","explanation":"9 in binary is 1001." },
    { "id":3,"topic":"Binary","difficulty":"easy","q":"Convert decimal 12 to binary.","options":["1100","1110","1010","1000"],"answer":"1100","explanation":"12 in binary is 1100." },
    { "id":4,"topic":"Ratios","difficulty":"easy","q":"Simplify the ratio 6:9.","options":["2:3","3:4","4:3","1:2"],"answer":"2:3","explanation":"Divide both by 3 → 2:3." },
    { "id":5,"topic":"Ratios","difficulty":"easy","q":"Simplify the ratio 8:12.","options":["2:3","1:2","3:2","4:3"],"answer":"2:3","explanation":"Divide both by 4 → 2:3." },
    { "id":6,"topic":"Ratio Word Problem","difficulty":"easy","q":"If 3 pens cost ₦150, how much do 5 pens cost?","options":["₦250","₦200","₦300","₦180"],"answer":"₦250","explanation":"Unit price ₦50; 5×50 = ₦250." },
    { "id":7,"topic":"Prime Factors","difficulty":"easy","q":"Prime factors of 18 (product form)?","options":["2×3×3","2×9","3×6","18"],"answer":"2×3×3","explanation":"18 = 2×3×3." },
    { "id":8,"topic":"LCM & HCF","difficulty":"easy","q":"Find the HCF of 8 and 12.","options":["4","6","2","8"],"answer":"4","explanation":"HCF(8,12)=4." },
    { "id":9,"topic":"Fractions","difficulty":"easy","q":"1/2 + 1/4 = ?","options":["3/4","1/4","2/3","1/2"],"answer":"3/4","explanation":"1/2 = 2/4; 2/4 + 1/4 = 3/4." },
    { "id":10,"topic":"Factorization","difficulty":"easy","q":"Factorise: 6x + 9.","options":["3(2x + 3)","6(x + 1.5)","9(0.666x + 1)","2(3x + 6)"],"answer":"3(2x + 3)","explanation":"GCF is 3." },
    { "id":11,"topic":"Arithmetic Mean","difficulty":"easy","q":"Find the mean of 4, 8, 12.","options":["8","6","9","7"],"answer":"8","explanation":"(4+8+12)/3 = 24/3 = 8." },
    { "id":12,"topic":"Square Roots","difficulty":"easy","q":"√25 = ?","options":["5","6","7","4"],"answer":"5","explanation":"25 is a perfect square: 5." },
    { "id":13,"topic":"Square Roots","difficulty":"easy","q":"√49 = ?","options":["7","6","8","9"],"answer":"7","explanation":"49 is a perfect square: 7." },
    { "id":14,"topic":"Binary","difficulty":"easy","q":"Convert decimal 10 to binary.","options":["1010","1110","1100","1001"],"answer":"1010","explanation":"10 in binary is 1010." },
    { "id":15,"topic":"Ratios","difficulty":"easy","q":"Simplify the ratio 9:12.","options":["3:4","2:3","4:3","1:2"],"answer":"3:4","explanation":"Divide both by 3." },
    { "id":16,"topic":"LCM & HCF","difficulty":"easy","q":"Find the LCM of 4 and 6.","options":["12","8","10","14"],"answer":"12","explanation":"LCM(4,6)=12." },
    { "id":17,"topic":"Fractions","difficulty":"easy","q":"2/3 − 1/6 = ?","options":["1/2","1/3","2/6","3/4"],"answer":"1/2","explanation":"2/3=4/6; 4/6−1/6=3/6=1/2." },
    { "id":18,"topic":"Prime Factors","difficulty":"easy","q":"Prime factors of 20 (product form)?","options":["2×2×5","4×5","10×2","2×10"],"answer":"2×2×5","explanation":"20=2×2×5." },
    { "id":19,"topic":"Arithmetic Mean","difficulty":"easy","q":"Mean of 3, 5, 7, 9.","options":["6","5","7","8"],"answer":"6","explanation":"Sum=24; 24/4=6." },
    { "id":20,"topic":"Square Roots","difficulty":"easy","q":"√81 = ?","options":["9","8","10","7"],"answer":"9","explanation":"81 is a perfect square." },

    { "id":21,"topic":"Binary","difficulty":"medium","q":"Convert binary 101101 to decimal.","options":["45","46","44","49"],"answer":"45","explanation":"32+8+4+1=45." },
    { "id":22,"topic":"Ratios","difficulty":"medium","q":"If the ratio of red to blue balls is 3:5 and total is 64, how many blue balls?","options":["40","24","32","20"],"answer":"40","explanation":"Blue=5/8 × 64=40." },
    { "id":23,"topic":"Ratio Word Problem","difficulty":"medium","q":"4 workers complete a job in 6 days. How long will 6 workers take (same rate)?","options":["4","5","3","6"],"answer":"4","explanation":"Time inversely proportional to workers: 4×6/6=4 days." },
    { "id":24,"topic":"Prime Factors","difficulty":"medium","q":"Prime factors of 84?","options":["2×2×3×7","2×2×2×7","3×3×7","2×3×5×7"],"answer":"2×2×3×7","explanation":"84=2×2×3×7." },
    { "id":25,"topic":"LCM & HCF","difficulty":"medium","q":"Find the LCM of 12 and 18.","options":["36","24","48","30"],"answer":"36","explanation":"LCM(12,18)=36." },
    { "id":26,"topic":"Fractions","difficulty":"medium","q":"Multiply: 3/5 × 10/9 = ?","options":["2/3","1/3","3/2","5/3"],"answer":"2/3","explanation":"(3×10)/(5×9)=30/45=2/3." },
    { "id":27,"topic":"Factorization","difficulty":"medium","q":"Factorise: 12xy + 18xy.","options":["6xy(2 + 3)","12xy(1 + 1.5)","3xy(4 + 6)","30xy"],"answer":"6xy(2 + 3)","explanation":"Common factor 6xy." },
    { "id":28,"topic":"Arithmetic Mean","difficulty":"medium","q":"Mean of 10, 14, 18, 22.","options":["16","15","17","18"],"answer":"16","explanation":"Sum=64; 64/4=16." },
    { "id":29,"topic":"Square Roots","difficulty":"medium","q":"Which is the nearest integer to √10000?","options":["100","99","101","90"],"answer":"100","explanation":"10000 is a perfect square: 100." },
    { "id":30,"topic":"Binary","difficulty":"medium","q":"Convert binary 111001 to decimal.","options":["57","58","49","61"],"answer":"57","explanation":"32+16+8+1=57." },
    { "id":31,"topic":"Ratios","difficulty":"medium","q":"Increase ₦1800 in ratio 2:3.","options":["₦2700","₦1200","₦900","₦1000"],"answer":"₦2700","explanation":"₦1800×3/2=₦900×3=₦2700." },
    { "id":32,"topic":"LCM & HCF","difficulty":"medium","q":"The HCF of (28, 42) = ?","options":["14","7","6","21"],"answer":"14","explanation":"HCF is 14." },
    { "id":33,"topic":"Fractions","difficulty":"medium","q":"(5/12) ÷ (5/18) = ?","options":["3/2","2/3","5/6","6/5"],"answer":"3/2","explanation":"(5/12)×(18/5)=18/12=3/2." },
    { "id":34,"topic":"Factorization","difficulty":"medium","q":"Factorise: 9xy + 12xy.","options":["3xy(3 + 4)","9xy(1 + 1.333...)","6xy(1.5 + 2)","xy(9 + 12)"],"answer":"3xy(3 + 4)","explanation":"GCF=3xy." },
    { "id":35,"topic":"Arithmetic Mean","difficulty":"medium","q":"Mean of 7, 11, 15, 19, 23.","options":["15","16","14","13"],"answer":"15","explanation":"Sum=75; 75/5=15." },

    { "id":36,"topic":"Binary","difficulty":"hard","q":"Convert decimal 173 to binary.","options":["10101101","10101100","10100101","10011101"],"answer":"10101101","explanation":"128+32+8+4+1=173." },
    { "id":37,"topic":"Ratios","difficulty":"hard","q":"If x:y = 7:9 and x = 56, find y.","options":["72","63","64","70"],"answer":"72","explanation":"k=56/7=8 → y=9×8=72." },
    { "id":38,"topic":"Ratio Word Problem","difficulty":"hard","q":"If y is inversely proportional to x and y=12 when x=5, find y when x=15.","options":["4","3","5","6"],"answer":"4","explanation":"xy=k → 12×5=60; y=60/15=4." },
    { "id":39,"topic":"Prime Factors","difficulty":"hard","q":"Prime factors of 468 (product form)?","options":["2×2×3×3×13","2×3×3×13","2×2×2×3×13","2×2×7×7"],"answer":"2×2×3×3×13","explanation":"468=2×2×3×3×13." },
    { "id":40,"topic":"LCM & HCF","difficulty":"hard","q":"Find the HCF of 144 and 216.","options":["72","36","24","48"],"answer":"72","explanation":"HCF(144,216)=72." },
    { "id":41,"topic":"Fractions","difficulty":"hard","q":"Compute: (7/8) ÷ (21/32).","options":["4/3","3/4","7/21","32/168"],"answer":"4/3","explanation":"(7/8)×(32/21)=224/168=4/3." },
    { "id":42,"topic":"Factorization","difficulty":"hard","q":"Factorise: 42a + 66a.","options":["6a(7 + 11)","3a(14 + 22)","2a(21 + 33)","a(42 + 66)"],"answer":"6a(7 + 11)","explanation":"GCF is 6a." },
    { "id":43,"topic":"Arithmetic Mean","difficulty":"hard","q":"The mean of 14, 18, 22 and x is 20. Find x.","options":["26","24","22","28"],"answer":"26","explanation":"Mean×4=80; sum known=54; x=26." },
    { "id":44,"topic":"Square Roots","difficulty":"hard","q":"√256 = ?","options":["16","14","18","12"],"answer":"16","explanation":"256 is a perfect square: 16." },
    { "id":45,"topic":"Binary","difficulty":"hard","q":"Convert decimal 255 to binary.","options":["11111111","11111110","11101111","11011111"],"answer":"11111111","explanation":"255 is 8 ones in binary." },
    { "id":46,"topic":"Ratios","difficulty":"hard","q":"If 3x:2y = 9:14, find x:y.","options":["3:7","7:3","9:28","14:9"],"answer":"3:7","explanation":"3x/2y=9/14 → x/y=(9/14)×(2/3)=3/7." },
    { "id":47,"topic":"LCM & HCF","difficulty":"hard","q":"Find LCM of 24, 36, and 60.","options":["360","180","240","720"],"answer":"360","explanation":"LCM(24,36,60)=360." },
    { "id":48,"topic":"Fractions","difficulty":"hard","q":"Compute: (11/12) × (18/55).","options":["3/10","10/3","1/2","33/110"],"answer":"3/10","explanation":"Cancel: 11 with 55, 18 with 12 → 3/10." },
    { "id":49,"topic":"Arithmetic Mean","difficulty":"hard","q":"Mean of 6 numbers is 15. If five are 10,12,16,18,20, find the sixth.","options":["14","15","18","24"],"answer":"14","explanation":"Total=90; known sum=76; missing=14." },
    { "id":50,"topic":"Square Roots","difficulty":"hard","q":"√900 = ?","options":["30","45","25","20"],"answer":"30","explanation":"900 is 30²." }
  ]
  </script>

  <script>
  (function(){
    const TOTAL_Q = 50;
    const TOTAL_SECONDS = 120 * 60; // 2.5h
    const STORAGE_PREFIX = 'plp256_cbt_';
    const SUBMIT_MAP = STORAGE_PREFIX + 'submits';
    const LAST_RESULT_PREFIX = STORAGE_PREFIX + 'result_';
    const CLOSED_FLAG = STORAGE_PREFIX + 'closed';
    const PENALTY = 300; // 5 min

    // DOM refs
    const headerEl = document.getElementById('pageHeader');
    const candidateNameEl = document.getElementById('candidateName');
    const startBtn = document.getElementById('startBtn');
    const checkResultBtn = document.getElementById('checkResultBtn');

    const testPanel = document.getElementById('testPanel');
    const resultDesktop = document.getElementById('resultDesktop');
    const resultMobile = document.getElementById('resultMobile');
    const resultsDock = document.getElementById('resultsDock');
    const resultsMain = document.getElementById('resultsMain');

    const qIndexEl = document.getElementById('qIndex');
    const qIndexTop = document.getElementById('qIndexTop');
    const qTotalTop = document.getElementById('qTotalTop');
    const topicTag = document.getElementById('topicTag');
    const difficultyTag = document.getElementById('difficultyTag');
    const qText = document.getElementById('qText');
    const optionsDiv = document.getElementById('options');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const markBtn = document.getElementById('markBtn');
    const submitContainer = document.getElementById('submitContainer');
    const progressCount = document.getElementById('progressCount');
    const markedCount = document.getElementById('markedCount');
    const progressFill = document.getElementById('progressFill');
    const jumpGrid = document.getElementById('jumpGrid');
    const navWrap = document.getElementById('navWrap');
    const statusMsg = document.getElementById('statusMsg');
    const timeOnQ = document.getElementById('timeOnQ');
    const timerEl = document.getElementById('timer');

    // Desktop results pieces
    const topicTbody = document.getElementById('topicTbody');
    const detailTbody = document.getElementById('detailTbody');
    const resMeta = document.getElementById('resMeta');
    const resScore = document.getElementById('resScore');
    const resPercent = document.getElementById('resPercent');
    const resTime = document.getElementById('resTime');

    // Mobile results
    const m_resMeta = document.getElementById('m_resMeta');
    const m_resScore = document.getElementById('m_resScore');
    const m_resPercent = document.getElementById('m_resPercent');
    const m_resTime = document.getElementById('m_resTime');
    const topicCards = document.getElementById('topicCards');
    const reviewStack = document.getElementById('reviewStack');

    // Utils
    const pad2=(n)=>(n<10?'0':'')+n;
    const nowSecs=()=>Math.floor(Date.now()/1000);
    const NAME_RE = /^[A-Za-z]{2,}(?:\s+[A-Za-z]{2,}){1,2}$/; // 2–3 words, each >=2 letters
    const sanitizeName = (n)=> n.trim().toLowerCase().replace(/\s+/g,' ').replace(/[^a-z\s]/g,'').replace(/\s+/g,'_');
    const formatHMS=(sec)=>{ if(sec<0) sec=0; const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60; return `${pad2(h)}:${pad2(m)}:${pad2(s)}`; };
    const shuffle=(a)=>{ const arr=a.slice(); for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr };

    function getBank(){
      try{ return JSON.parse(document.getElementById('questionBank').textContent.trim()); }
      catch(e){ alert('Question bank JSON malformed.'); return []; }
    }

    // State
    let state={
      started:false, candidate:'', sanitized:'',
      quiz:[], index:0, answers:[], marked:[], perQuestionTime:[],
      timeRemaining:TOTAL_SECONDS, lastSaved:nowSecs(), submitted:false
    };
    let timerInterval=null, lastSwitch=null;

    // Storage helpers
    const keyFor=(san)=> STORAGE_PREFIX+san;
    const saveState=()=>{ state.lastSaved=nowSecs(); if(state.sanitized && !state.submitted){ localStorage.setItem(keyFor(state.sanitized), JSON.stringify(state)); } };
    const loadState=(san)=>{ const raw=localStorage.getItem(keyFor(san)); if(!raw) return null; try{return JSON.parse(raw)}catch(e){return null} };
    const markSubmitted=(san,result)=>{ const map=JSON.parse(localStorage.getItem(SUBMIT_MAP)||'{}'); map[san]=true; localStorage.setItem(SUBMIT_MAP, JSON.stringify(map)); localStorage.setItem(LAST_RESULT_PREFIX+san, JSON.stringify(result)); };
    const isSubmitted=(san)=>{ const map=JSON.parse(localStorage.getItem(SUBMIT_MAP)||'{}'); return !!map[san]; };

    /* ---------- Progress + Nav ---------- */
    function renderJumpGrid(){
      jumpGrid.innerHTML='';
      for(let i=0;i<state.quiz.length;i++){
        const btn=document.createElement('button');
        btn.className='jumpBtn'+(state.answers[i]!=null?' answered':'')+(state.marked[i]?' marked':'')+(i===state.index?' current':'');
        btn.textContent=i+1;
        btn.onclick=()=>goToQuestion(i);
        jumpGrid.appendChild(btn);
      }
      queueMicrotask(scrollCurrentIntoView);
    }
    function scrollCurrentIntoView(){
      const current = jumpGrid.querySelector('.jumpBtn.current');
      if(!current) return;
      try{
        current.scrollIntoView({behavior:'smooth', block:'nearest', inline:'nearest'});
        const cRect = navWrap.getBoundingClientRect();
        const rRect = current.getBoundingClientRect();
        if(rRect.top < cRect.top + 6 || rRect.bottom > cRect.bottom - 6){
          navWrap.scrollTop = current.offsetTop - (navWrap.clientHeight/2 - current.offsetHeight/2);
        }
      }catch(_){}
    }
    function updateProgressUI(){
      const answered = state.answers.filter(v=>v!=null).length;
      progressCount.textContent = `${answered} / ${state.quiz.length} answered`;
      markedCount.textContent = `${state.marked.filter(Boolean).length} marked`;
      progressFill.style.width = `${Math.round(answered/state.quiz.length*100)}%`;
    }

    /* ---------- Render Question ---------- */
    function renderQuestion(){
      const i=state.index, q=state.quiz[i];
      qIndexEl.textContent=i+1; qIndexTop.textContent=i+1; qTotalTop.textContent=state.quiz.length;
      topicTag.textContent=q.topic; difficultyTag.textContent=q.difficulty;
      qText.textContent=q.q;

      optionsDiv.innerHTML='';
      const opts = shuffle(q.options);
      opts.forEach((opt,idx)=>{
        const id=`opt_${i}_${idx}`;
        const label=document.createElement('label');
        label.htmlFor=id;
        label.innerHTML=`<input type="radio" name="choice" id="${id}" value="${opt}" style="margin-right:8px"> ${opt}`;
        optionsDiv.appendChild(label);
      });
      if(state.answers[i]!=null){
        const radios=[...document.getElementsByName('choice')];
        radios.find(r=>r.value===state.answers[i])?.setAttribute('checked',true);
      }
      [...document.getElementsByName('choice')].forEach(r=>{
        r.onchange=()=>{
          state.answers[i]=r.value; saveState(); updateProgressUI(); renderJumpGrid();
          statusMsg.textContent='Answer saved.'; setTimeout(()=>statusMsg.textContent='',800);
        };
      });

      prevBtn.disabled = i===0;
      nextBtn.disabled = i===state.quiz.length-1;
      markBtn.textContent = state.marked[i] ? 'Unmark' : 'Mark';

      submitContainer.innerHTML='';
      if(i===state.quiz.length-1 && !state.submitted){
        const s=document.createElement('button');
        s.className='btn warn'; s.textContent='Submit Test';
        s.onclick=()=>openSubmitModal();
        submitContainer.appendChild(s);
      }

      const elapsed = lastSwitch ? Math.floor((Date.now()-lastSwitch)/1000) : 0;
      const base = state.perQuestionTime[i] || 0;
      timeOnQ.textContent = `Time on question: ${base + elapsed}s`;

      renderJumpGrid(); updateProgressUI();
    }

    // Navigation
    function goToQuestion(i){
      if(!state.started) return;
      const now=Date.now();
      if(lastSwitch){
        const elapsed=Math.floor((now-lastSwitch)/1000);
        state.perQuestionTime[state.index]+=elapsed;
      }
      lastSwitch=now; state.index=i; saveState(); renderQuestion();
    }
    prevBtn.onclick=()=> goToQuestion(Math.max(0, state.index-1));
    nextBtn.onclick=()=> goToQuestion(Math.min(state.quiz.length-1, state.index+1));
    markBtn.onclick=()=>{ state.marked[state.index]=!state.marked[state.index]; saveState(); renderQuestion(); };

    // Keyboard arrows
    window.addEventListener('keydown',e=>{
      if(!state.started||state.submitted) return;
      if(e.key==='ArrowLeft') prevBtn.click();
      if(e.key==='ArrowRight') nextBtn.click();
    });

    /* ---------- Clock + Anti-cheat ---------- */
    function startClock(){
      lastSwitch = Date.now();
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(()=>{
        state.timeRemaining--;
        const elapsed = lastSwitch? Math.floor((Date.now()-lastSwitch)/1000) : 0;
        const base = state.perQuestionTime[state.index] || 0;
        timeOnQ.textContent = `Time on question: ${base + elapsed}s`;
        timerEl.textContent = formatHMS(state.timeRemaining);
        saveState();
        if(state.timeRemaining<=0){ clearInterval(timerInterval); autoSubmit('Time Expired'); }
      },1000);
    }
    function stopClock(){ if(timerInterval){ clearInterval(timerInterval); timerInterval=null; } }

    window.addEventListener('beforeunload',()=>{
      if(state.started && !state.submitted){
        if(lastSwitch){
          const elapsed=Math.floor((Date.now()-lastSwitch)/1000);
          state.perQuestionTime[state.index]+=elapsed;
          lastSwitch=Date.now();
        }
        saveState();
        localStorage.setItem(CLOSED_FLAG, String(nowSecs()));
      }
    });
    let penaltyFlagSinceBlur=false;
    window.addEventListener('blur', ()=>{ if(!state.started||state.submitted) return; localStorage.setItem(CLOSED_FLAG,String(nowSecs())); penaltyFlagSinceBlur=true; });
    window.addEventListener('visibilitychange', ()=>{
      if(!state.started||state.submitted) return;
      if(document.visibilityState==='hidden'){ localStorage.setItem(CLOSED_FLAG,String(nowSecs())); penaltyFlagSinceBlur=true; }
      else {
        const closedTs=parseInt(localStorage.getItem(CLOSED_FLAG)||'0',10);
        if(closedTs && closedTs>(state.lastSaved||0)){
          state.timeRemaining=Math.max(0,state.timeRemaining-PENALTY);
          timerEl.textContent=formatHMS(state.timeRemaining);
          alert('Anti-cheat: 5-minute penalty applied.');
          localStorage.removeItem(CLOSED_FLAG);
        } else if(penaltyFlagSinceBlur){
          state.timeRemaining=Math.max(0,state.timeRemaining-PENALTY);
          timerEl.textContent=formatHMS(state.timeRemaining);
          alert('Anti-cheat: 5-minute penalty applied.');
        }
        penaltyFlagSinceBlur=false;
      }
    });

    /* ---------- Start / Resume ---------- */
    startBtn.onclick=()=>{
      const raw = candidateNameEl.value.trim().replace(/\s+/g,' ');
      if(!NAME_RE.test(raw)){
        return alert('Enter your full name as 2–3 words, letters only, each at least 2 letters (e.g., “Amina Yusuf” or “Ola Tunde Ade”).');
      }
      const san = sanitizeName(raw);
      if(isSubmitted(san)) return alert('This student already submitted. Ask teacher to unlock.');

      // resume?
      const saved = loadState(san);
      if(saved && !saved.submitted){
        const elapsedSinceSave = nowSecs()-(saved.lastSaved||nowSecs());
        let newRemaining = Math.max((saved.timeRemaining||TOTAL_SECONDS)-elapsedSinceSave,0);
        const closedTs=parseInt(localStorage.getItem(CLOSED_FLAG)||'0',10);
        if(closedTs && closedTs>(saved.lastSaved||0)){
          newRemaining=Math.max(newRemaining-PENALTY,0);
          alert('Resume after app switch. Penalty applied.');
          localStorage.removeItem(CLOSED_FLAG);
        }
        if(newRemaining<=0){ localStorage.removeItem(keyFor(san)); }
        else if(confirm('Resume previous attempt?')){
          state=saved;
          state.timeRemaining=newRemaining;
          state.started=true; state.candidate=raw; state.sanitized=san;
          testPanel.style.display='block'; resultDesktop.style.display='none'; resultMobile.style.display='none';
          timerEl.textContent=formatHMS(state.timeRemaining);
          setTimeout(()=>{ renderQuestion(); startClock(); }, 50);
          return;
        } else { localStorage.removeItem(keyFor(san)); }
      }

      // fresh
      const bank = getBank();
      if(bank.length!==TOTAL_Q) alert(`Bank has ${bank.length} items; expected ${TOTAL_Q}. Continuing with available.`);
      state.quiz = shuffle(bank);
      state.index=0;
      state.answers=Array(state.quiz.length).fill(null);
      state.marked=Array(state.quiz.length).fill(false);
      state.perQuestionTime=Array(state.quiz.length).fill(0);
      state.timeRemaining = TOTAL_SECONDS;
      state.started=true; state.candidate=raw; state.sanitized=san; state.submitted=false;

      testPanel.style.display='block'; resultDesktop.style.display='none'; resultMobile.style.display='none';
      timerEl.textContent = formatHMS(TOTAL_SECONDS);
      setTimeout(()=>{ renderQuestion(); startClock(); saveState(); }, 50);
    };

    /* ---------- Compute / Submit ---------- */
    function computeResults(){
      let score=0; const details=[]; const topicStats={};
      for(let i=0;i<state.quiz.length;i++){
        const q=state.quiz[i], given=state.answers[i], correct=(given===q.answer);
        if(correct) score++;
        details.push({ index:i+1, q:q.q, given, answer:q.answer, correct, explanation:q.explanation, topic:q.topic, time:state.perQuestionTime[i] });
        if(!topicStats[q.topic]) topicStats[q.topic]={correct:0,total:0,time:0};
        topicStats[q.topic].total++; if(correct) topicStats[q.topic].correct++; topicStats[q.topic].time+=state.perQuestionTime[i];
      }
      return {score,details,topicStats};
    }

    function autoSubmit(reason='User submitted'){
      if(state.submitted) return;
      const now=Date.now();
      if(lastSwitch){ const elapsed=Math.floor((now-lastSwitch)/1000); state.perQuestionTime[state.index]+=elapsed; }
      state.submitted=true; stopClock(); saveState();

      const res=computeResults();
      const resultObj={
        candidate:state.candidate,
        timestamp:new Date().toLocaleString(),
        score:res.score,
        total:state.quiz.length,
        topicStats:res.topicStats,
        details:res.details,
        timeUsed:state.perQuestionTime.reduce((a,b)=>a+b,0)
      };
      markSubmitted(state.sanitized, resultObj);

      testPanel.style.display='none';
      showResults(resultObj, reason);
    }

    function openSubmitModal(){
      const root=document.createElement('div'); 
      root.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:9999';
      root.innerHTML=`<div style="background:#fff;padding:14px;border-radius:12px;width:92%;max-width:420px">
        <h3 style="margin:0 0 6px">Submit Test?</h3>
        <p class="small">You are on the last question. Submitting is final.</p>
        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button class="btn ghost" id="cancelSubmit">Cancel</button>
          <button class="btn warn" id="confirmSubmit">Submit</button>
        </div>
      </div>`;
      document.body.appendChild(root);
      root.querySelector('#cancelSubmit').onclick=()=>root.remove();
      root.querySelector('#confirmSubmit').onclick=()=>{ root.remove(); autoSubmit('User submitted (confirmed)'); };
    }

    /* ---------- Results Rendering (Desktop + Mobile) ---------- */
    function formatTopicRows(topicStats){
      return Object.keys(topicStats).map(t=>{
        const s=topicStats[t];
        return `<tr><td>${t}</td><td>${s.correct}</td><td>${s.total}</td><td>${Math.round(s.correct/s.total*100)}%</td><td class="mono">${formatHMS(s.time)}</td></tr>`;
      }).join('');
    }
    function formatDetailRows(details){
      return details.map(d=>{
        return `<tr>
          <td class="mono">Q${d.index}</td>
          <td>${d.topic}</td>
          <td>${d.q}</td>
          <td>${d.given ?? '<em>None</em>'}</td>
          <td>${d.answer}</td>
          <td>${d.correct?'<span style="color:var(--success);font-weight:700">✓</span>':'<span style="color:var(--danger);font-weight:700">✗</span>'}</td>
          <td class="mono">${formatHMS(d.time)}</td>
        </tr>`;
      }).join('');
    }

    function setActiveTab(id){
      document.querySelectorAll('.tabBtn').forEach(b=>{
        const on = b.dataset.tab===id;
        b.setAttribute('aria-selected', on ? 'true' : 'false');
      });
      document.querySelectorAll('.tabPanel').forEach(p=>{
        p.classList.toggle('active', p.id === `tab-${id}`);
      });
      // keep scroll position top for panel change
      if(resultsMain) resultsMain.scrollTo(0, 0);
    }

    function enterResultsMode(){
      // measure header height for perfect lock
      const h = headerEl ? headerEl.offsetHeight : 64;
      document.documentElement.style.setProperty('--headH', h + 'px');
      document.body.classList.add('results-mode');
      document.getElementById('backHomeBtn').style.display = 'block';
      resultsDock.style.display='grid';
      window.scrollTo(0,0);
    }
    function exitResultsMode(){
      document.body.classList.remove('results-mode');
      resultsDock.style.display='none';
      document.getElementById('backHomeBtn').style.display = 'none';
    }
    
    document.getElementById('backHomeBtn').onclick = () => {
    exitResultsMode();
    window.scrollTo(0,0);
};

    function showResults(resultObj, reason=''){
      const pct = Math.round((resultObj.score/resultObj.total)*100);

      // Desktop values
      resMeta.textContent = `Submitted: ${resultObj.timestamp} ${reason?('• '+reason):''}`;
      resScore.textContent = `${resultObj.score}/${resultObj.total}`;
      resPercent.textContent = `${pct}%`;
      resTime.textContent = formatHMS(resultObj.timeUsed);
      topicTbody.innerHTML = formatTopicRows(resultObj.topicStats);
      detailTbody.innerHTML = formatDetailRows(resultObj.details);

      // Mobile values
      m_resMeta.textContent = resMeta.textContent;
      m_resScore.textContent = resScore.textContent;
      m_resPercent.textContent = resPercent.textContent;
      m_resTime.textContent = resTime.textContent;

      topicCards.innerHTML = Object.keys(resultObj.topicStats).map(t=>{
        const s=resultObj.topicStats[t];
        return `<div class="topicCard">
          <div class="topicRow">
            <div class="left">${t}</div>
            <div class="right">Time: ${formatHMS(s.time)}</div>
          </div>
          <div class="row" style="margin-top:6px; flex-wrap:nowrap">
            <span class="pill">Correct: ${s.correct}/${s.total}</span>
            <span class="pill">Accuracy: ${Math.round(s.correct/s.total*100)}%</span>
          </div>
        </div>`;
      }).join('');

      reviewStack.innerHTML = resultObj.details.map(d=>{
        const pass = d.correct ? '✓' : '✗';
        const passClr = d.correct ? 'var(--success)' : 'var(--danger)';
        return `<details class="qcard" data-q>
          <summary>
            <span>Q${d.index} • <span style="color:${passClr};font-weight:800">${pass}</span> • ${formatHMS(d.time)}</span>
            <span class="pill">${d.topic}</span>
          </summary>
          <div class="body">
            <div class="qtext" style="font-size:15px; font-weight:700">${d.q}</div>
            <div class="small">Your answer: <strong>${d.given ?? '<em>None</em>'}</strong></div>
            <div class="small">Correct answer: <strong>${d.answer}</strong></div>
            <div class="small" style="margin-top:6px; background:#fff7e0; padding:8px; border-radius:8px">
              <strong>Explanation:</strong> ${d.explanation}
            </div>
          </div>
        </details>`;
      }).join('');

      // Show correct shell per device
      if(window.matchMedia('(min-width: 900px)').matches){
        resultDesktop.style.display='block';
        enterResultsMode();
        setActiveTab('overview');
      }else{
        resultDesktop.style.display='none';
        resultMobile.style.display='block';
        exitResultsMode();
      }
      window.scrollTo({top:0, behavior:'smooth'});
    }

    // Vertical tab interactions (desktop)
    document.addEventListener('click', (e)=>{
      const b = e.target.closest('.tabBtn');
      if(!b) return;
      setActiveTab(b.dataset.tab);
    });

    /* ---------- Check result ---------- */
    checkResultBtn.onclick=()=>{
      const name = candidateNameEl.value.trim().replace(/\s+/g,' ');
      if(!NAME_RE.test(name)) return alert('Enter your full name as 2–3 words, letters only, each ≥ 2 letters.');
      const san = sanitizeName(name);
      const raw = localStorage.getItem(LAST_RESULT_PREFIX+san);
      if(!raw) return alert('No completed result found for this name on this device.');
      const resultObj = JSON.parse(raw);
      testPanel.style.display='none';
      showResults(resultObj, 'Viewed');
    };

    /* ---------- Autosave tick ---------- */
    setInterval(()=>{
      if(!state.started || state.submitted) return;
      if(lastSwitch){
        const elapsed=Math.floor((Date.now()-lastSwitch)/1000);
        const base = state.perQuestionTime[state.index] || 0;
        timeOnQ.textContent=`Time on question: ${base + elapsed}s`;
      }
      saveState();
    },1000);

    // Init timer text
    timerEl.textContent = formatHMS(TOTAL_SECONDS);

    // Keep results layout height correct on resize
    window.addEventListener('resize', ()=>{
      if(document.body.classList.contains('results-mode')){
        const h = headerEl ? headerEl.offsetHeight : 64;
        document.documentElement.style.setProperty('--headH', h + 'px');
      }
    });
  })();
  </script>
</body>
</html>
